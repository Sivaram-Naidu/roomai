<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register for Event - AgentRoomAI</title>
    <!-- 1. Include Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <link rel="stylesheet" href="register.css" />
  </head>
  <body>
    <div class="form-container">
      <!-- This is now one single form -->
      <form id="registration-form">
        <h1 id="event-title">Event Registration</h1>

        <div class="form-group">
          <label for="EventName">Event Name</label>
          <!-- This field will be auto-filled and disabled -->
          <input
            type="text"
            id="EventName"
            name="EventName"
            class="form-control"
            required
            readonly
          />
          <!-- Hidden field to store the price -->
          <input type="hidden" id="Amount" name="Amount" />
        </div>

        <div class="form-group">
          <label for="FullName">Full Name</label>
          <input
            type="text"
            id="FullName"
            name="FullName"
            class="form-control"
            required
          />
        </div>

        <div class="form-group">
          <label for="Email">Email Address</label>
          <input
            type="email"
            id="Email"
            name="Email"
            class="form-control"
            required
          />
        </div>

        <div class="form-group">
          <label for="Phone">Phone Number</label>
          <input
            type="tel"
            id="Phone"
            name="Phone"
            class="form-control"
            required
          />
        </div>

        <div class="form-group">
          <label for="OrgName">College / Company Name</label>
          <input
            type="text"
            id="OrgName"
            name="OrgName"
            class="form-control"
            required
          />
        </div>

        <!-- 
              This button will now have two functions:
              1. Submit for FREE events
              2. Trigger payment for PAID events
            -->
        <button type="submit" class="submit-btn" id="submit-button">
          Register Now
        </button>

        <div id="form-message"></div>
      </form>
    </div>

    <script>
      const RAZORPAY_KEY_ID = "rzp_live_RXfGkXxK4K1Rra";

      // Your local backend server URL
      const SERVER_URL = "http://localhost:3000";

      // Your Google Script URL (for FREE events only)
      const GOOGLE_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbw9ZbGMOJAfDQtdLeUBcbuYMlqdBLa8TT1qpRpLhuPLFkh79sz9tl1Vvb8IzJN3lzj9/exec";

      // --- 1. GET ALL FORM ELEMENTS ---
      const form = document.getElementById("registration-form");
      const submitButton = document.getElementById("submit-button");
      const messageDiv = document.getElementById("form-message");
      const eventTitle = document.getElementById("event-title");
      const eventNameInput = document.getElementById("EventName");
      const amountInput = document.getElementById("Amount");

      let price = 0;

      // --- 2. AUTO-FILL FORM ON PAGE LOAD ---
      window.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const eventName = urlParams.get("event");
        price = parseInt(urlParams.get("price") || "0", 10);

        if (eventName) {
          eventTitle.textContent = `Register for ${eventName}`;
          eventNameInput.value = eventName;
          amountInput.value = price;
        }

        if (price > 0) {
          submitButton.textContent = `Pay ₹${price} & Register`;
        } else {
          submitButton.textContent = "Register for Free";
        }
      });

      // --- 3. HANDLE FORM SUBMISSION ---
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        setLoading(true);

        if (price > 0) {
          // PAID Event: Start Razorpay flow
          await handlePaidRegistration();
        } else {
          // FREE Event: Submit directly to Google Sheets
          await handleFreeRegistration();
        }

        setLoading(false);
      });

      // --- 4. FUNCTION FOR FREE REGISTRATION ---
      async function handleFreeRegistration() {
        try {
          const formData = new FormData(form);
          formData.append("PaymentID", "N/A (Free)"); // Add free tag
          formData.append("Price", "free"); // Tell script it's free

          const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.result === "success") {
            showMessage(
              "Registration successful! You will receive a confirmation email.",
              "success"
            );
            form.reset();
          } else {
            throw new Error(result.message || "Failed to save to Google Sheet");
          }
        } catch (error) {
          showMessage(`Error: ${error.message}`, "error");
        }
      }

      // --- 5. FUNCTION FOR PAID REGISTRATION ---
      async function handlePaidRegistration() {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
          // Step 1: Create an order on your backend
          const orderResponse = await fetch(`${SERVER_URL}/create-order`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!orderResponse.ok) {
            throw new Error("Failed to create payment order.");
          }

          const order = await orderResponse.json();

          // Step 2: Open Razorpay Checkout
          const options = {
            key: RAZORPAY_KEY_ID,
            amount: order.amount,
            currency: order.currency,
            name: "AgentRoomAI Events",
            description: `Registration for ${data.EventName}`,
            order_id: order.id,
            handler: async function (response) {
              // Step 3: Payment is successful, now verify on backend
              setLoading(true, "Verifying payment...");

              const verificationData = {
                ...response,
                ...data, // Send user details along with payment IDs
              };

              const verifyResponse = await fetch(
                `${SERVER_URL}/verify-payment`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(verificationData),
                }
              );

              const verifyResult = await verifyResponse.json();

              if (verifyResult.status === "success") {
                showMessage(
                  "Payment successful! Registration complete.",
                  "success"
                );
                form.reset();
              } else {
                throw new Error(
                  verifyResult.message || "Payment verification failed."
                );
              }
            },
            prefill: {
              name: data.FullName,
              email: data.Email,
              contact: data.Phone,
            },
            notes: {
              eventName: data.EventName,
            },
            theme: {
              color: "#f97316", // Orange theme
            },
          };

          // Open the Razorpay popup
          const rzp = new Razorpay(options);
          rzp.open();
        } catch (error) {
          showMessage(`Error: ${error.message}`, "error");
          setLoading(false); // Make sure to re-enable button on error
        }
      }

      // --- HELPER FUNCTIONS ---
      function setLoading(isLoading, message = "Submitting...") {
        submitButton.disabled = isLoading;
        submitButton.textContent = isLoading
          ? message
          : price > 0
          ? `Pay ₹${price} & Register`
          : "Register for Free";
      }

      function showMessage(message, type) {
        messageDiv.textContent = message;
        messageDiv.className =
          type === "success" ? "message-success" : "message-error";
      }
    </script>
  </body>
</html>
